<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识星球助手 - 管理后台</title>
    <link rel="stylesheet" href="admin.css">
</head>

<body>
    <!-- 登录遮罩层 -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>🔐 管理后台登录</h2>
            <div class="login-form">
                <input type="password" id="loginPassword" class="form-control" placeholder="请输入管理密码"
                    onkeypress="if(event.key==='Enter')doLogin()">
                <button class="btn btn-primary" onclick="doLogin()">登录</button>
            </div>
            <p id="loginError" class="login-error"></p>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="logo">
            <h1>🎛️ 管理后台</h1>
        </div>
        <nav class="nav">
            <a href="#dashboard" class="nav-item active" onclick="showPage('dashboard')">
                <span class="icon">📊</span>
                <span>仪表板</span>
            </a>
            <a href="#licenses" class="nav-item" onclick="showPage('licenses')">
                <span class="icon">🔑</span>
                <span>密钥管理</span>
            </a>
            <a href="#devices" class="nav-item" onclick="showPage('devices')">
                <span class="icon">📱</span>
                <span>设备管理</span>
            </a>
            <a href="#ipManage" class="nav-item" onclick="showPage('ipManage')">
                <span class="icon">🌐</span>
                <span>IP 管理</span>
            </a>
            <a href="#deviceOverview" class="nav-item" onclick="showPage('deviceOverview')">
                <span class="icon">🖥️</span>
                <span>设备总览</span>
            </a>
            <a href="#review" class="nav-item" onclick="showPage('review')">
                <span class="icon">✅</span>
                <span>激活审核</span>
            </a>
            <a href="#logs" class="nav-item" onclick="showPage('logs')">
                <span class="icon">📋</span>
                <span>操作日志</span>
            </a>
            <a href="#settings" class="nav-item" onclick="showPage('settings')">
                <span class="icon">⚙️</span>
                <span>系统设置</span>
            </a>
            <a href="#debug" class="nav-item" onclick="showPage('debug')">
                <span class="icon">🔍</span>
                <span>密钥调试</span>
            </a>
        </nav>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <!-- 顶部栏 -->
        <div class="topbar">
            <h2 id="pageTitle">仪表板</h2>
            <div class="topbar-actions">
                <button class="btn btn-sm" onclick="loadCurrentPage()">🔄 刷新</button>
            </div>
        </div>

        <!-- 消息提示 -->
        <div id="message" class="message"></div>

        <!-- 仪表板 -->
        <div id="dashboard" class="page active">
            <div class="stats-grid" id="statsGrid"></div>

            <!-- 快捷操作 -->
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="showPage('licenses')">
                    <span class="quick-icon">🎫</span>
                    <span class="quick-text">生成临时密钥</span>
                </button>
                <button class="quick-action-btn" onclick="showPage('licenses')">
                    <span class="quick-icon">🔑</span>
                    <span class="quick-text">注册正式密钥</span>
                </button>
                <button class="quick-action-btn" onclick="showPage('review')">
                    <span class="quick-icon">✅</span>
                    <span class="quick-text">审核激活</span>
                </button>
                <button class="quick-action-btn" onclick="showPage('logs')">
                    <span class="quick-icon">📋</span>
                    <span class="quick-text">查看日志</span>
                </button>
            </div>

            <!-- 数据趋势图表 -->
            <div class="dashboard-charts">
                <div class="card">
                    <div class="card-header">
                        <h3>📈 密钥使用趋势（最近7天）</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="licenseChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>📊 密钥状态分布</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>最近密钥</h3>
                </div>
                <div class="card-body">
                    <div id="recentLicenses"></div>
                </div>
            </div>

            <!-- 今日活动 -->
            <div class="card">
                <div class="card-header">
                    <h3>📅 今日活动</h3>
                </div>
                <div class="card-body">
                    <div id="todayActivity"></div>
                </div>
            </div>
        </div>

        <!-- 密钥管理 -->
        <div id="licenses" class="page">
            <div class="card">
                <div class="card-header">
                    <h3>🎫 临时密钥配置</h3>
                </div>
                <div class="card-body">
                    <p class="hint">💡 配置临时密钥的名称、有效期、任务次数和激活次数限制，修改后立即生效</p>
                    
                    <div class="form-group">
                        <label>临时密钥名称</label>
                        <input type="text" id="tempLicenseName" class="form-control" placeholder="例如：AUTOEMAIL8888">
                        <p class="hint">用户使用此密钥激活插件</p>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>有效期（小时）</label>
                            <input type="number" id="tempValidHours" class="form-control" min="1" max="168" value="12">
                            <p class="hint">1-168小时</p>
                        </div>

                        <div class="form-group">
                            <label>最大任务次数</label>
                            <input type="number" id="tempMaxTasks" class="form-control" min="1" max="1000" value="10">
                            <p class="hint">1-1000次</p>
                        </div>

                        <div class="form-group">
                            <label>最大激活次数</label>
                            <input type="number" id="tempMaxActivations" class="form-control" min="1" max="100" value="3">
                            <p class="hint">每个设备可激活次数</p>
                        </div>
                    </div>

                    <div class="form-row">
                        <button class="btn btn-primary" onclick="saveTempLicenseConfig()">💾 保存配置</button>
                        <button class="btn" onclick="loadTempLicenseConfig()">🔄 刷新</button>
                    </div>

                    <div id="tempConfigStatus" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
                        <strong>当前配置：</strong>
                        <div id="tempConfigDisplay" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>生成临时密钥</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <label style="margin-right: 10px;">生成数量：</label>
                        <input type="number" id="tempLicenseCount" class="form-control" value="1" min="1" max="50"
                            style="width: 100px; margin-right: 10px;">
                        <button class="btn btn-primary" onclick="generateTempLicenses()">🎫 生成临时密钥</button>
                    </div>
                    <p class="hint">💡 临时密钥的有效期和任务次数由上方配置决定</p>

                    <div id="tempLicensesResult" style="margin-top: 20px;"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>注册正式密钥</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="generateNewLicense()">🎲 生成密钥</button>
                        <input type="text" id="newLicense" class="form-control" readonly placeholder="点击生成密钥">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>客户名称</label>
                            <input type="text" id="customer" class="form-control" value="星球助手">
                        </div>

                        <div class="form-group">
                            <label>过期时间</label>
                            <input type="date" id="expireDate" class="form-control" value="2049-12-31">
                        </div>

                        <div class="form-group">
                            <label>最大设备数</label>
                            <select id="maxDevices" class="form-control">
                                <option value="1">1 台</option>
                                <option value="2">2 台</option>
                                <option value="3">3 台</option>
                                <option value="5">5 台</option>
                                <option value="10">10 台</option>
                                <option value="100" selected>100 台</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="registerLicense()">✅ 注册密钥</button>
                    <p class="hint">💡 客户首次激活时会自动绑定 IP</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>所有密钥</h3>
                    <div class="card-actions">
                        <input type="text" id="searchKeyword" class="form-control" placeholder="搜索密钥或客户"
                            style="width: 200px;" onkeypress="if(event.key==='Enter')searchLicenses()">
                        <select id="filterStatus" class="form-control" style="width: 120px;" onchange="applyFilters()">
                            <option value="all">全部状态</option>
                            <option value="active">正常</option>
                            <option value="expired">已过期</option>
                            <option value="banned">已封禁</option>
                        </select>
                        <button class="btn" onclick="searchLicenses()">🔍 搜索</button>
                        <button class="btn" onclick="clearFilters()">✖️ 清除</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 批量操作栏 -->
                    <div id="batchActionsBar" class="batch-actions-bar" style="display: none;">
                        <div class="batch-info">
                            已选择 <strong id="selectedCount">0</strong> 个密钥
                        </div>
                        <div class="batch-buttons">
                            <button class="btn btn-warning btn-sm" onclick="batchBanLicenses()">批量封禁</button>
                            <button class="btn btn-success btn-sm" onclick="batchUnbanLicenses()">批量解封</button>
                            <button class="btn btn-danger btn-sm" onclick="batchDeleteLicenses()">批量删除</button>
                            <button class="btn btn-sm" onclick="exportSelectedLicenses()">导出选中</button>
                            <button class="btn btn-sm" onclick="clearSelection()">取消选择</button>
                        </div>
                    </div>
                    <div id="allLicenses"></div>
                    <div id="licensesPagination"></div>
                </div>
            </div>
        </div>

        <!-- 设备管理 -->
        <div id="devices" class="page">
            <div class="card">
                <div class="card-header">
                    <h3>查询设备</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <input type="text" id="deviceLicense" class="form-control" placeholder="输入密钥">
                        <button class="btn btn-primary" onclick="queryDevices()">🔍 查询</button>
                    </div>
                </div>
            </div>
            <div id="devicesResult"></div>
        </div>

        <!-- IP 管理 -->
        <div id="ipManage" class="page">
            <div class="card">
                <div class="card-header">
                    <h3>🌐 所有 IP 地址</h3>
                    <div class="card-actions">
                        <input type="text" id="ipSearchKeyword" class="form-control" placeholder="搜索 IP 地址"
                            style="width: 200px;">
                        <button class="btn" onclick="searchIPs()">🔍 搜索</button>
                        <button class="btn" onclick="loadAllIPs()">🔄 刷新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="stats-grid" id="ipStatsGrid" style="margin-bottom: 20px;"></div>
                    <div id="allIPsContainer"></div>
                </div>
            </div>
        </div>

        <!-- 设备总览 -->
        <div id="deviceOverview" class="page">
            <div class="card">
                <div class="card-header">
                    <h3>🖥️ 所有设备</h3>
                    <div class="card-actions">
                        <input type="text" id="deviceSearchKeyword" class="form-control" placeholder="搜索设备 ID"
                            style="width: 200px;">
                        <button class="btn" onclick="searchDevicesGlobal()">🔍 搜索</button>
                        <button class="btn" onclick="loadAllDevices()">🔄 刷新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="stats-grid" id="deviceStatsGrid" style="margin-bottom: 20px;"></div>
                    <div id="allDevicesContainer"></div>
                </div>
            </div>
        </div>

        <!-- 激活审核 -->
        <div id="review" class="page">
            <div class="card">
                <div class="card-header">
                    <h3>⏳ 待审核激活</h3>
                    <button class="btn" onclick="loadPendingIPs()">🔄 刷新</button>
                </div>
                <div class="card-body">
                    <p class="hint">💡 客户使用临时密钥激活后会出现在这里，3小时内最多使用5次任务，审核通过即可永久使用</p>
                    <div id="pendingIPsContainer"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>✅ 已通过 IP 白名单</h3>
                    <button class="btn" onclick="loadApprovedIPs()">🔄 刷新</button>
                </div>
                <div class="card-body">
                    <div id="approvedIPsContainer"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>🚫 已拒绝 IP 名单</h3>
                    <button class="btn" onclick="loadRejectedIPs()">🔄 刷新</button>
                </div>
                <div class="card-body">
                    <p class="hint">💡 被拒绝的 IP 无法使用插件，如果误操作可以点击恢复</p>

                    <!-- 手动封禁 IP 输入框 -->
                    <div class="form-row"
                        style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <input type="text" id="banIPInput" class="form-control" placeholder="输入要封禁的 IP 地址"
                            style="width: 300px; margin-right: 10px;">
                        <button class="btn btn-danger" onclick="manualBanIP()">🚫 封禁 IP</button>
                    </div>

                    <div id="rejectedIPsContainer"></div>
                </div>
            </div>
        </div>

        <!-- 操作日志 -->
        <div id="logs" class="page">
            <div class="card">
                <div class="card-header">
                    <h3>操作日志</h3>
                    <div class="card-actions">
                        <input type="text" id="ipSearchInput" class="form-control" placeholder="输入 IP 地址搜索"
                            style="width: 250px;" onkeypress="if(event.key==='Enter')searchLogsByIP()">
                        <button class="btn btn-primary" onclick="searchLogsByIP()">🔍 搜索 IP</button>
                        <button class="btn" onclick="clearIPSearch()">✖️ 清除</button>
                        <button class="btn" onclick="loadLogs()">🔄 刷新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="logsSearchInfo" style="display: none; padding: 10px; margin-bottom: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                        <span id="logsSearchText"></span>
                    </div>
                    <div id="logsContainer"></div>
                    <div id="logsPagination"></div>
                </div>
            </div>
        </div>

        <!-- 系统设置 -->
        <div id="settings" class="page">
            <div class="card">
                <div class="card-header">
                    <h3>API 配置</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>API 地址（固定）</label>
                        <input type="text" class="form-control" value="https://1340181402-3thvnndcwl.ap-guangzhou.tencentscf.com" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                        <p class="hint">💡 API 地址已固定，无法修改</p>
                    </div>

                    <div class="form-group">
                        <label>管理员密钥</label>
                        <input type="password" id="adminKey" class="form-control" value="ADMIN-KEY-2025">
                    </div>

                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveConfig()">💾 保存配置</button>
                        <button class="btn" onclick="testConnection()">🔌 测试连接</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>数据管理</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <button class="btn" onclick="exportAllData()">📥 导出数据</button>
                        <button class="btn" onclick="showImportDialog()">📤 导入数据</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>🚀 版本管理</h3>
                    <div class="card-actions">
                        <button class="btn" onclick="checkCurrentVersion()">🔄 刷新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>当前最新版本</label>
                        <div id="currentVersionDisplay"
                            style="padding: 10px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef; margin-bottom: 20px;">
                            加载中...
                        </div>
                    </div>

                    <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                        <h4 style="margin-bottom: 15px;">发布新版本</h4>
                        <div class="form-group">
                            <label>版本号 (如 1.0.1)</label>
                            <input type="text" id="newVersionInput" class="form-control" placeholder="1.0.0">
                        </div>
                        <div class="form-group">
                            <label>下载链接</label>
                            <input type="text" id="newDownloadUrlInput" class="form-control" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label>更新说明</label>
                            <textarea id="newUpdateNotesInput" class="form-control" rows="4"
                                placeholder="请输入更新内容..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="publishNewVersion()">📤 发布新版本</button>
                    </div>

                    <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                        <h4 style="margin-bottom: 15px;">📜 历史版本记录</h4>
                        <div id="versionHistoryContainer">加载中...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 密钥调试 -->
        <div id="debug" class="page">
            <div class="card">
                <div class="card-header">
                    <h3>⚙️ 配置</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>API 地址（固定）</label>
                        <input type="text" class="form-control" value="https://1340181402-3thvnndcwl.ap-guangzhou.tencentscf.com" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                        <p class="hint">💡 API 地址已固定，无法修改</p>
                    </div>
                    <div class="form-group">
                        <label>管理员密钥</label>
                        <input type="text" id="debugAdminKey" class="form-control" value="ADMIN-KEY-2025">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>🧪 密钥验证测试（随机 IP 和设备ID）</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>测试密钥</label>
                        <input type="text" id="debugTestLicense" class="form-control"
                            placeholder="输入密钥，如: ZSXQ-TEMP-2025 或 ZSXQ-8888-0001">
                    </div>
                    <div id="debugTestInfo" class="test-info"
                        style="display: none; background: #e2e3e5; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <span style="margin-right: 20px;">🌐 <strong>测试IP:</strong> <span
                                id="debugCurrentIP">-</span></span>
                        <span>🖥️ <strong>设备ID:</strong> <span id="debugCurrentDevice">-</span></span>
                    </div>
                    <div class="form-row" style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="debugTestValidate()">🔐 测试激活</button>
                        <button class="btn btn-success" onclick="debugTestStartTask()">▶️ 测试开始任务</button>
                        <button class="btn btn-primary" onclick="debugTestBoth()">🚀 同时测试</button>
                        <button class="btn" onclick="debugRegenerateTestData()">🔄 重新生成随机数据</button>
                    </div>
                    <div id="debugTestResult" class="debug-result"
                        style="display:none; background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;">
                    </div>
                </div>
            </div>

            <div class="card" style="border-left: 4px solid #28a745;">
                <div class="card-header">
                    <h3>🔄 存量用户测试（模拟重装插件）</h3>
                </div>
                <div class="card-body">
                    <p class="hint">测试已有激活记录的用户，使用任意密钥是否能直接通过验证</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>选择存量IP</label>
                            <select id="debugExistingIP" class="form-control">
                                <option value="">-- 点击加载按钮 --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>选择存量设备ID</label>
                            <select id="debugExistingDevice" class="form-control">
                                <option value="">-- 点击加载按钮 --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>测试密钥（可以输入任意值）</label>
                        <input type="text" id="debugExistingTestLicense" class="form-control" value="ZSXQ-RANDOM-TEST"
                            placeholder="输入任意密钥测试">
                    </div>
                    <div class="form-row">
                        <button class="btn" onclick="debugLoadExistingData()">🔄 加载存量数据</button>
                        <button class="btn btn-success" onclick="debugTestExistingIP()">🌐 测试存量IP（激活）</button>
                        <button class="btn btn-success" onclick="debugTestExistingIPStartTask()">🌐 测试存量IP（任务）</button>
                        <button class="btn btn-success" onclick="debugTestExistingDevice()">🖥️ 测试存量设备（激活）</button>
                        <button class="btn btn-success" onclick="debugTestExistingDeviceStartTask()">🖥️
                            测试存量设备（任务）</button>
                        <button class="btn btn-primary" onclick="debugTestExistingBoth()">🚀 综合测试</button>
                    </div>
                    <div id="debugExistingResult" class="debug-result"
                        style="display:none; background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>📋 查看待审核列表</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <button class="btn" onclick="debugListPendingIPs()">🔄 刷新列表</button>
                        <button class="btn" onclick="debugAnalyzePendingIPs()">📊 分析问题</button>
                    </div>
                    <div id="debugPendingResult" class="debug-result"
                        style="display:none; background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;">
                    </div>
                    <div id="debugAnalysisResult" class="debug-result"
                        style="display:none; background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>📜 查看日志</h3>
                </div>
                <div class="card-body">
                    <button class="btn" onclick="debugGetLogs()">查看最近50条日志</button>
                    <div id="debugLogsResult" class="debug-result"
                        style="display:none; background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px; white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="admin.js"></script>
</body>

</html>
